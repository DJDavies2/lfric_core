!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the W0 mass matrix computation
!>
module invert_local_operator_kernel_mod_test

  implicit none 


contains

  @test
  subroutine invert_local_operator_kernel_test()

    use pFUnit_Mod
    use invert_local_operator_kernel_mod, &
                                    only : invert_local_operator_code
    use constants_mod,              only : i_def, r_def
    use operator_mod,               only : operator_type, operator_proxy_type

    use configuration_mod,     only: QUAD, element_order
    use mesh_mod,              only: mesh_type, PLANE_BI_PERIODIC
    use function_space_mod,    only: function_space_type                       &
                                   , purge_function_spaces
    use fs_continuity_mod,     only: W3
    use reference_element_mod, only: reference_cube, deallocate_reference      &
                                   , reference_element

    implicit none


    type(mesh_type)           :: mesh
    type(function_space_type) :: fs
    type(function_space_type), pointer :: w3_fs => null()

    real(kind=r_def) :: tol
    real(kind=r_def) :: answer

    integer :: cell

    ! Required for calling mass matrix kernel    
    type( operator_type ) :: mm, mm_inv

    integer :: nlayers, ndf

    type( operator_proxy_type) :: mm_p, mm_inv_p
    
    tol = 1.0e-6_r_def

    reference_element = QUAD
    call reference_cube()
    mesh = mesh_type(PLANE_BI_PERIODIC)


    ! Test mass matrix kernel
    w3_fs => fs%get_instance( mesh, element_order, W3 )
    mm = operator_type(W3_fs,W3_fs) 
    mm_p = mm%get_proxy()  
    mm_inv = operator_type(W3_fs,W3_fs) 
    mm_inv_p = mm_inv%get_proxy()  

    nlayers  = mm_p%fs_from%get_nlayers()

    ndf  = mm_p%fs_from%get_ndf()    

    cell = 1
    ! Create the data
    mm_p%local_stencil(:,:,:) = 5.0_r_def
    call invert_local_operator_code( cell,                         &
                                     nlayers,                      &
                                     mm_inv_p%ncell_3d,            &
                                     mm_inv_p%local_stencil,       &
                                     mm_p%ncell_3d,                &
                                     mm_p%local_stencil,           &
                                     ndf)
 
    answer = 1.0_r_def/5.0_r_def
    @assertEqual(answer, mm_inv_p%local_stencil(1, 1, 1 ), tol)

    ! Tear down ...
    call deallocate_reference()
    call purge_function_spaces()


  end subroutine invert_local_operator_kernel_test

end module invert_local_operator_kernel_mod_test
